# fix ave/correlate command

# 構文
```
fix ID group-ID ave/correlate Nevery Nrepeat Nfreq value1 value2 ... keyword args ...
```
- ID および group-ID は fix コマンドで記述されています。
- ave/correlate = この fix コマンドのスタイル名
- Nevery = 指定したタイムステップごとに入力値を使用
- Nrepeat = 蓄積する相関時間ウィンドウの数
- Nfreq = 指定したタイムステップごとに時間ウィンドウの平均を計算
- 1つ以上の入力値をリストすることが可能
- value = c_ID, c_ID[N], f_ID, f_ID[N], v_name

c_ID = 指定した ID の compute によって計算されるグローバルスカラー  
c_ID[I] = 指定した ID の compute によって計算されるグローバルベクトルの第 I 成分  
f_ID = 指定した ID の fix によって計算されるグローバルスカラー  
f_ID[I] = 指定した ID の fix によって計算されるグローバルベクトルの第 I 成分  
v_name = 指定した名前の equal-style 変数によって計算されるグローバル値  

- ゼロまたは複数のキーワード/引数ペアを追加することができます。
- キーワードと対応する引数:

type 引数: auto, upper, lower, auto/upper, auto/lower, または full  
auto: 各値をそれ自身と相関させる  
upper: 各値を後続の値と相関させる  
lower: 各値を先行する値と相関させる  
auto/upper: auto と upper の組み合わせ  
auto/lower: auto と lower の組み合わせ  
full: 各値を、それ自身を含むすべての他の値と相関させる (auto + upper + lower)  
ave 引数: one または running  
one: 相関の蓄積を毎回 Nfreq ステップでリセット  
running: 相関を継続的に蓄積  
start 引数: Nstart  
Nstart: このタイムステップから相関の蓄積を開始  
prefactor 引数: value  
value: すべての相関データをスケールするための係数  
file 引数: filename  
filename: 相関データを出力するファイル名  
overwrite 引数: none  
none: 出力ファイルを上書きして最新の出力のみを保持  
title1 引数: string  
string: 出力ファイルの1行目に記載するテキスト  
title2 引数: string  
string: 出力ファイルの2行目に記載するテキスト  
title3 引数: string  
string: 出力ファイルの3行目に記載するテキスト  

# 例
```
fix 1 all ave/correlate 5 100 1000 c_myTemp file temp.correlate
fix 1 all ave/correlate 1 50 10000 &
          c_myArray[1] c_myArray[2] c_myArray[3] &
       type upper ave running title1 "My correlation data"
```

# 説明
1つ以上のグローバルスカラー値を入力として使用し、数ステップごとにそれらの間の時間相関を計算し、異なる時間間隔で相関データを平均化します。得られた相関値は[variable]()で時間積分したり、thermo_style custom などの他の[output commands]()で使用したり、ファイルに書き出すことができます。

このコマンドで指定されたグループは無視されます。ただし、指定された値は、計算を行う compute や fix が独自の「グループ」定義を保持している場合があることに注意してください。

リストされた各値は、[compute]() や [fix]() の結果、または equal スタイルの[variable]の評価の結果である可能性があります。いずれの場合でも、compute、fix、または変数はグローバル量を生成する必要があり、原子単位またはローカル量を生成してはいけません。もし compute、fix、または変数から原子単位の量を空間的または時間的に平均化したりヒストグラム化したりしたい場合は、[fix ave/spatial]()、[fix ave/atom]()、または [fix ave/histo]() コマンドを参照してください。原子単位の量を単一のグローバル量に合計したい場合は、[compute reduce]() コマンドを参照してください。

グローバル量を生成する [compute]() は、そのスタイル名に「atom」という単語が含まれていないものです。グローバル量を生成する [fix]() はごくわずかです。どの fix がそのような値を生成するかについては、個々の fix に関するドキュメントページを参照してください。equal スタイルの[variable]()だけがこの fix と一緒に使用できます。atom スタイルの変数は使用できません、なぜならそれらは原子単位の値を生成するためです。

入力値はすべてスカラーである必要があります。入力値間のどのような相関を計算するかは、以下で説明する type キーワードによって決定されます。

Nevery、Nrepeat、および Nfreq の引数は、入力値が相関データを計算するために使用されるタイムステップを指定します。入力値は Nevery タイムステップごとにサンプリングされます。前回のサンプルに対する相関データは、Nfreq の倍数のタイムステップで計算されます。初期時刻から出力タイムステップまでのサンプルセットを考えてください。初期時刻はシミュレーションの開始時刻または最後の出力時刻である可能性があります。オプションについては ave キーワードを参照してください。このサンプルセットに対して、相関値 Cij は次のように計算されます：

```
Cij(delta) = ave(Vi(t)*Vj(t+delta))
```

これは、入力値 Vi と Vj の間の相関値で、時間のデルタで分離されています。注意すべき点は、ペアの2番目の値 Vj は常に後のタイムステップでサンプリングされたものであるということです。ave() は、時間デルタで区切られたセット内のすべてのサンプルペアに対する平均を表します。使用される最大デルタは、サイズが (Nrepeat-1)**Nevery となります。このように、入力値のペア間の相関は、Nrepeat 回の相関データを生成します：

```
Cij(0), Cij(Nevery), Cij(2*Nevery), ..., Cij((Nrepeat-1)*Nevery)
```

例えば、Nevery=5、Nrepeat=6、Nfreq=100 の場合、タイムステップ 0, 5, 10, 15, ..., 100 の値が最終的な平均を計算するために使用されます。計算される平均値は6つです：Cij(0), Cij(5), Cij(10), Cij(15), Cij(20), Cij(25)。タイムステップ 100 における Cij(10) は、次の19個のサンプルの平均となります：Vi(0)*Vj(10), Vi(5)*Vj(15), Vi(10)*Vj(20), Vi(15)*Vj(25), ..., Vi(85)*Vj(95), Vi(90)*Vj(100)。

Nfreq は Nevery の倍数でなければならず、Nevery と Nrepeat はゼロであってはなりません。また、ave キーワードがデフォルトの「one」に設定されている場合、Nfreq >= (Nrepeat-1)**Nevery が必要です。

値が「c_」で始まる場合、計算IDが入力スクリプトで事前に定義されている必要があります。角括弧で囲まれた項目が追加されていない場合、計算によって計算されたグローバルスカラーが使用されます。角括弧で囲まれた項目が追加されている場合、計算によって計算されたグローバルベクトルのI番目の要素が使用されます。

なお、[compute reduce]() コマンドは、原子ごとの量をグローバルなスカラーやベクトルに合計することができ、これにより fix ave/correlate でアクセスすることが可能になります。また、入力スクリプトではなく、[thermodynaminc output]()や他のfix（例：fix nvt や fix temp/rescale）で定義された計算も使用できます。これらのコマンドのドキュメントページでは、これらの計算のIDを確認できます。ユーザーは自分で計算スタイルのコードを書くこともでき、それをLIGGGHTS(R)-PUBLICに追加することができます。

値が「f_」で始まる場合、fix IDが入力スクリプトで事前に定義されている必要があります。角括弧で囲まれた項目が追加されていない場合、fixによって計算されたグローバルスカラーが使用されます。角括弧で囲まれた項目が追加されている場合、fixによって計算されたグローバルベクトルのI番目の要素が使用されます。

一部のfixは、特定のタイムステップでのみその値を生成しますが、そのタイムステップはNeveryと互換性がある必要があります。そうでない場合、エラーが発生します。ユーザーは独自のfixスタイルのコードを記述し、それをLIGGGHTS(R)-PUBLICに追加することもできます。

値が「v_」で始まる場合、入力スクリプトで事前に定義された変数名が続かなければなりません。参照できるのはequalスタイルの変数のみです。詳細は [variable]() コマンドを参照してください。なお、equalスタイルの変数は、個々の原子の属性や熱力学的キーワードを参照する式を定義することができ、評価時に他の計算（compute）、fix、または変数を呼び出すこともできます。これにより、時間的に相関させるための量を指定するための非常に一般的な手段となります。

このfixの動作には、追加のオプションのキーワードも影響を与えます。

type キーワードは、どの入力値のペアが相関されるかを決定します。N個の入力値 Vi（i = 1 から N）について、ペアの数は Npair となります。なお、ペア内の2番目の値 Vi(t)*Vj(t+delta) は常に後の時刻でサンプリングされた値です。

- type が auto に設定されている場合、各入力値は自分自身と相関されます。つまり、Cii = Vi*Vi（i = 1 から N）で、Npair = N となります。
- type が upper に設定されている場合、各入力値はその後のすべての値と相関されます。つまり、Cij = ViVj（i < j）で、Npair = N(N-1)/2 となります。
- type が lower に設定されている場合、各入力値はその前のすべての値と相関されます。つまり、Cij = ViVj（i > j）で、Npair = N(N-1)/2 となります。
- type が auto/upper に設定されている場合、各入力値は自分自身とその後のすべての値と相関されます。つまり、Cij = ViVj（i >= j）で、Npair = N(N+1)/2 となります。
- type が auto/lower に設定されている場合、各入力値は自分自身とその前のすべての値と相関されます。つまり、Cij = ViVj（i <= j）で、Npair = N(N+1)/2 となります。
- type が full に設定されている場合、各入力値は自分自身と他のすべての値と相関されます。つまり、Cij = Vi*Vj（i,j = 1 から N）で、Npair = N^2 となります。

ave キーワードは、Nfreqタイムステップごとに相関サンプルの累積がどうなるかを決定します。ave 設定が one の場合、累積はNfreqタイムステップごとにリセットまたはゼロ化されます。したがって、連続するNfreqタイムステップでの出力は基本的に独立しています。ただし、例外として、Cij(0) = Vi(T)*Vj(T) の値は、TがNfreqの倍数であるタイムステップTで、TおよびT+Nfreqの両方の相関出力に寄与します。

ave 設定が running の場合、累積は決してゼロ化されません。したがって、任意のタイムステップでの相関データの出力は、fixが定義されてから毎Neveryステップごとに累積されたサンプルの平均となります。累積は、[unfix]() コマンドでfixを削除するか、fixを再定義して再指定することでのみ再開できます。

start キーワードは、相関サンプルの累積が開始されるタイムステップを指定します。デフォルトはステップ0です。これを大きな値に設定することで、非平衡状態のデータが相関平均に加算されるのを避けることができます。

prefactor キーワードは、相関データが平均化された後に掛け算される定数を指定します。これは実質的に Vi*Vj に対するスケールファクターで、時間窓の大きさや他の単位換算を考慮するために使用されます。

file キーワードはファイル名を指定することができます。毎 Nfreq ステップごとに、相関データの配列がファイルに書き込まれます。行数は上記で説明したように Nrepeat です。列数は Npair+2 で、これも上記で説明した通りです。したがって、ファイルはこれらの配列セクションの連続になります。

overwrite キーワードは、出力ファイルを最新の出力で継続的に上書きします。これにより、ファイルには1タイムステップ分の出力だけが含まれるようになります。このオプションは、ave running 設定でのみ使用できます。

title1、title2、title3 キーワードは、出力ファイルの最初の3行に印刷される文字列を指定するために使用できます。file キーワードが使用された場合、LIGGGHTS(R)-PUBLICはこれらに対してデフォルト値を使用するため、必ずしも指定する必要はありません。

デフォルトでは、これらのヘッダー行は次のようになります：

```
# Time-correlated data for fix ID
# TimeStep Number-of-time-windows
# Index TimeDelta Ncount valueI*valueJ valueI*valueJ ...
```

1行目では、ID が fix-ID に置き換えられます。2行目は、各出力セクションの最初に印刷される2つの値を説明しています。3行目では、値のペアが fix ave/correlate コマンドからの適切なフィールドに置き換えられます。

Sij を入力値 I と J に対する時系列相関データのセット、つまり Nrepeat の値とします：

```
Sij = Cij(0), Cij(Nevery), Cij(2*Nevery), ..., Cij((Nrepeat-1)*Nevery)
```
下記で説明するように、これらのデータはグローバル配列の1列として出力され、実際には相関行列となります。

[equal-style variable]()に定義されたトラップ関数は、このデータベクトルの時間積分を行うために使用できます（台形則を使用）。これは、時系列相関データから導出できるさまざまな量を計算するために有用です。もし時間積分のための正規化係数が必要な場合、それは変数の式に含めるか、prefactor キーワードを介して指定することができます。

# Restart, fix_modify, output, run start/stop, minimize info
この fix に関する情報は[binary restart file]()には書き込まれません。[fix_modify]() オプションはこの fix には適用されません。

この fix は、さまざまな[output commands]()でアクセスできるグローバル配列の値を計算します。値は、Nfreq の倍数のタイムステップでのみアクセス可能です。これは、平均化が実行されるタイムステップです。グローバル配列の行数は Nrepeat、列数は Npair+2 です。最初の列には、相関を計算するために使用される入力値ペア間のタイムデルタ（タイムステップ単位）が含まれています。2列目には、相関平均に寄与するサンプル数が含まれています。残りの Npair 列は、type キーワードで決定される N の入力値の I,J ペア用です。

- type = auto の場合、Npair = N の列は次のように並べられます：C11, C22, ..., CNN。 
- type = upper の場合、Npair = N*(N-1)/2 の列は次のように並べられます：C12, C13, ..., C1N, C23, ..., C2N, C34, ..., CN-1N。 
- type = lower の場合、Npair = N*(N-1)/2 の列は次のように並べられます：C21, C31, C32, C41, C42, C43, ..., CN1, CN2, ..., CNN-1。 
- type = auto/upper の場合、Npair = N*(N+1)/2 の列は次のように並べられます：C11, C12, C13, ..., C1N, C22, C23, ..., C2N, C33, C34, ..., CN-1N, CNN。 
- type = auto/lower の場合、Npair = N*(N+1)/2 の列は次のように並べられます：C11, C21, C22, C31, C32, C33, C41, ..., C44, CN1, CN2, ..., CNN-1, CNN。 
- type = full の場合、Npair = N^2 の列は次のように並べられます：C11, C12, ..., C1N, C21, C22, ..., C2N, C31, ..., C3N, ..., CN1, ..., CNN-1, CNN。


このfixによって計算された配列の値は「集中的な（intensive）」値として扱われます。もし原子の数で割る必要がある場合は、その処理を後の処理ステップで行う必要があります（例えば、[variable]()で使用する際に）。

このfixのパラメータは、runコマンドのstart/stopキーワードでは使用できません。また、このfixはエネルギー最小化中には呼び出されません。

# 制限事項
none

# 関連コマンド
[compute](), [fix ave/time](), [fix ave/atom](), [fix ave/spatial](), [fix ave/histo](), [variable]()

# デフォルト
オプションのデフォルトは、ave = one、type = auto、start = 0、ファイル出力なし、title 1, 2, 3 = 上記のような文字列、prefactor = 1.0 です。












