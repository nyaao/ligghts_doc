# fix ave/spatial command

# 構文
```
fix ID group-ID ave/spatial Nevery Nrepeat Nfreq dim origin delta ... value1 value2 ... keyword args ...
```
- ID、group-IDはfixコマンドで文書化されています。
- ave/spatial = このfixコマンドのスタイル名
- Nevery = この多くのタイムステップごとに入力値を使用
- Nrepeat = 平均値を計算するために入力値を使用する回数
- Nfreq = この多くのタイムステップごとに平均値を計算
- dim, origin, deltaは1次元、2次元、または3次元のビンに対して1回、2回、または3回繰り返すことができます。

dim = x、y、またはz  
origin = 下端、中央、上端、または座標値（距離単位）  
delta = dim方向の空間ビンの厚さ（距離単位）  

- 1つ以上の入力値をリストすることができます。
- 値 = vx, vy, vz, fx, fy, fz, density/mass, density/number, c_ID, c_ID[I], f_ID, f_ID[I], v_name  

vx, vy, vz, fx, fy, fz = 原子属性（速度、力の成分）  
density/number, density/mass = 数密度または質量密度  
c_ID = computeコマンドで計算された原子ごとのベクトル（IDで指定）  
c_ID[I] = computeコマンドで計算された原子ごとの配列のI番目の列（IDで指定）  
f_ID = fixコマンドで計算された原子ごとのベクトル（IDで指定）  
f_ID[I] = fixコマンドで計算された原子ごとの配列のI番目の列（IDで指定）  
v_name = atom-style変数で計算された原子ごとのベクトル（名前で指定）

- ゼロ個以上のキーワード/引数ペアを追加できます。
- キーワード = norm, units, file, ave, overwrite, title1, title2, title3, write_ts, std

units 引数 = box, lattice, reduced
norm 引数 = all, sample
region 引数 = region-ID
region-ID = 空間平均に貢献するために原子が含まれる必要のある領域のID

ave 引数 = one, running, window M
one = 新しい平均値をNfreqステップごとに出力
running = すべての前のNfreqステップの累積平均を出力
window M = 最も最近のM個のNfreqステップの平均を出力

file 引数 = filename
filename = 結果を出力するファイル名

overwrite 引数 = none
none = 最新の出力で出力ファイルを上書き

title1 引数 = string
string = 出力ファイルの1行目に印刷するテキスト

title2 引数 = string
string = 出力ファイルの2行目に印刷するテキスト

title3 引数 = string
string = 出力ファイルの3行目に印刷するテキスト

write_ts 引数 = yes, no
yes または no = 時間ステップ情報とサンプル数をファイルに書き込むかどうか

std 引数 = N1 N2 filename
N1 = サンプリングするための1つのビンあたりの粒子数の下限
N2 = サンプリングするための1つのビンあたりの粒子数の上限
filename = 結果を出力するファイル

# 例
```
fix 1 all ave/spatial 10000 1 10000 z lower 0.02 c_myCentro units reduced &
                      title1 "My output values"
fix 1 flow ave/spatial 100 10 1000 y 0.0 1.0 vx vz norm sample file vel.profile
fix 1 flow ave/spatial 100 5 1000 z lower 1.0 y 0.0 2.5 density/mass ave running
fix 1 all ave/spatial 1000 1 1000 x 0 1e-3 y 0 1e-3 z 0 1e-3 f_tracer[0] file bin_data.dat std 124 126 samples_data.dat
```

# 説明
1つ以上の原子ごとのベクトルを入力として、数ステップごとにそれらの値を現在の原子の座標に基づいて1次元、2次元、または3次元のビンに空間的に分割し、ビンの値を長期的なタイムスケールで平均化します。結果として得られたビンの平均値は、他の[output commands]()（例：[thermo_style custom]()）で使用でき、ファイルに書き出すこともできます。

このコマンドで指定されたグループは、そのグループに含まれる原子のみがビンの平均に貢献することを意味します。regionキーワードが使用されている場合、原子はグループと指定された幾何学的な[region]()の両方に含まれている必要があり、その場合のみビンの平均に貢献します。

リストされた各値は、原子の属性（位置、速度、力成分）、質量または数密度、またはcompute、fix、またはatom-style変数の評価結果であることができます。後者の場合、[compute]()、[fix]()、または[variable]()はグローバルな量ではなく、原子ごとの量を生成する必要があります。compute、fix、または変数からグローバルな量をタイム平均したい場合は、[fix ave/time]()コマンドを参照してください。

原子ごとの量を生成する[compute]()は、そのスタイル名に「atom」という単語を含むものです。個別の[fix]()のドキュメントページで、どのfixが原子ごとの量を生成するかを確認できます。styleがatomの[variable]()のみがこのfixで使用可能で、その他のスタイルの変数はグローバルな量を生成するため使用できません。

各入力ベクトルの原子ごとの値は、他の入力ベクトルの原子ごとの値とは独立してビンに分けて平均化されます。

ビンのサイズと次元（1d = 層やスラブ、2d = 鉛筆、3d = ボックス）は、dim、origin、deltaの設定によって決定され、それぞれが1回、2回、または3回指定されるかどうかで変わります。詳細については以下を参照してください。

[!WARNING]このfixは、各プロセッサでサイズがNbins×Nvaluesの配列を作成することによって動作します。Nbinsはビンの総数、Nvaluesは指定された入力値の数です。各プロセッサはその原子をループし、適切なビンに値をカウントします。その後、すべてのプロセッサで配列が合計されます。これにより、多くのビン（2dや3dビンでは簡単に行える）を使用すると、メモリと計算コスト（プロセッサ間での合計）が増加するため、適切なビン数を使用するよう注意が必要です。

Nevery、Nrepeat、Nfreq引数は、入力値がどのタイムステップで使用され、それらがビンに分けられ、平均に貢献するかを指定します。最終的な平均化された量は、Nfreqの倍数のタイムステップで生成されます。平均は、前のシミュレーション部分で毎Neveryタイムステップごとに計算されたNrepeat個の量に基づいています。NfreqはNeveryの倍数でなければならず、NeveryはNrepeatが1であってもゼロであってはなりません。また、平均値に貢献するタイムステップは重複してはならず、すなわちNfreq > (Nrepeat-1)*Neveryが必要です。

例えば、Nevery=2、Nrepeat=6、Nfreq=100の場合、タイムステップ90、92、94、96、98、100での値が最終的な平均を計算するために使用され、100タイムステップでその結果が得られます。同様に、タイムステップ190、192、194、196、198、200では、200タイムステップで計算されます。もしNrepeat=1、Nfreq=100の場合、時間平均は行われず、単にタイムステップ100、200などで値が生成されます。

各アトムのプロパティは、各ビン内のアトムに対しても平均化されます。ビンは1次元の層やスラブ、2次元の鉛筆、または3次元のボックスになります。これは、fix ave/spatial コマンドで dim、origin、delta 設定が何回（1回、2回、または3回）指定されているかによります。2次元または3次元のビンの場合、dim = x を dim = y の前に指定する、または dim = y を dim = z の前に指定する制限はありません。特定の次元におけるビンは、その次元におけるビンサイズが delta で指定されます。平均化が行われるたびに、または最初にアトムのプロパティが計算されるタイミングで、ビンの数、ビンのサイズ、境界が計算されます。したがって、シミュレーションボックスのサイズがシミュレーション中に変更されると、ビンの数やその境界も変更される可能性があります。各次元において、ビンは指定された原点に対して定義されます。この原点は、シミュレーションボックスの低い/高い端（dim における）またはその中心点、または指定された座標値である可能性があります。原点から始まり、ボックスを完全にカバーするために十分な数のビンが両方向に作成されます。その後、各タイムステップで、すべてのアトムはそのビンの1つにマッピングされます。次元内で最も低い/高いビンを超えるアトムは、その次元で最初/最後のビンにカウントされます。

直交シミュレーションボックスの場合、ビンはxyz座標軸に沿った層、鉛筆、またはボックスになります。三斜め（非直交）シミュレーションボックスの場合、ビンはシミュレーションボックスの傾いた面に平行に配置されます。LIGGGHTS(R)-PUBLICのマニュアルのこのセクションで、三斜めボックスの幾何学についての議論を参照してください。そこで説明されているように、傾いたシミュレーションボックスにはエッジベクトルa、b、cがあります。その命名法では、x次元のビンは「b」クロス「c」方向に法線を持つ面を持っています。y次元のビンは「a」クロス「c」方向に法線を持つ面を持っています。そして、z次元のビンは「a」クロス「b」方向に法線を持つ面を持っています。これらのビンのサイズと位置を明確に定義するためには、三斜めシミュレーションボックスを使用する際には、単位オプションを「reduced」に設定する必要があることに注意してください。

原子属性値（vx, vy, vz, fx, fy, fz）は明白です。なお、他の原子属性（原子位置x, y, zを含む）は、このfixの入力として使用することができます。これには、[compute property/atom]()コマンドを使用し、その計算結果から入力値を指定する必要があります。

density/number値は、各ビン内で数密度が計算されることを意味します。つまり、各原子に対して重み付け1が適用されます。density/mass値は、各ビン内で質量密度が計算されることを意味します。つまり、各原子はその質量で重み付けされます。得られた密度は、ビンの体積で正規化され、単位が数/体積や密度として出力されます。各単位選択肢における密度の定義については、[units]()コマンドのドキュメントページを参照してください。例えば、g/cm³のような単位で定義されています。

値が「c_」で始まる場合、入力スクリプトで以前に定義されたcompute IDを指定する必要があります。もし角括弧で囲まれた整数が追加されていない場合、computeによって計算された原子ごとのベクトルが使用されます。角括弧で囲まれた整数が追加されている場合、computeによって計算された原子ごとの配列のI番目の列が使用されます。ユーザーは独自のcomputeスタイルのコードを記述し、それをLIGGGHTS(R)-PUBLICに追加することもできます。

値が「f_」で始まる場合、入力スクリプトで以前に定義されたfix IDを指定する必要があります。もし角括弧で囲まれた整数が追加されていない場合、fixによって計算された原子ごとのベクトルが使用されます。角括弧で囲まれた整数が追加されている場合、fixによって計算された原子ごとの配列のI番目の列が使用されます。注意すべきは、いくつかのfixは特定のタイムステップでのみその値を生成するため、Neveryと互換性がないとエラーが発生することです。ユーザーは独自のfixスタイルのコードを記述し、それをLIGGGHTS(R)-PUBLICに追加することもできます。

値が「v_」で始まる場合、入力スクリプトで以前に定義された変数名を指定する必要があります。atomスタイルの変数は、熱力学的キーワードやさまざまな原子ごとの属性を参照することができ、評価される際に他のcompute、fix、または変数を呼び出すことができるため、これは空間的に平均化するための原子ごとの量を生成する非常に一般的な方法です。

追加のオプションのキーワードも、このfixの動作に影響を与えます。

unitsキーワードは、binサイズdeltaと、原点が座標値である場合の原点の距離単位の意味を決定します。直交シミュレーションボックスの場合、3つのオプションのいずれでも使用できます。非直交（トリクリニック）シミュレーションボックスの場合、reducedオプションのみ使用できます。

「box」値は、[units]()コマンドで定義された標準的な距離単位を選択します。例えば、units = real または metal の場合、距離単位はアンストロームになります。「lattice」値は、距離単位が格子間隔であることを意味します。[lattice]()コマンドを事前に使用して格子間隔を定義する必要があります。「reduced」値は、0から1の間で正規化された無次元値を意味し、シミュレーションボックスの下面と上面をそれぞれ表します。したがって、origin値が0.5であれば、ボックスの中心を示します。delta値が0.1であれば、その次元でボックスを10分割することを意味します。

非直交ボックスを考慮し、x次元における1d層またはスラブのようなビンの場合、ボックスがどれだけ傾いていても、originが0.0であれば、シミュレーションボックスの「b」×「c」平面の下側から層が始まり、originが1.0であれば、ボックスの「b」×「c」面の上側から層が始まります。delta値が0.1であれば、ボックスのサイズや形状に関わらず、0.0から1.0までに10層が配置されます。

「norm」キーワードは、Nfreqステップごとに出力される平均の計算方法に影響を与えます。「all」設定の場合、ビンの量はすべてのNrepeatサンプルのすべての原子にわたって合計され、ビン内の原子のカウントも同様に合計されます。ビンの出力値は「Total-quantity / Total-count」となります。言い換えれば、これはNfreqの全体のタイムスケールにわたる平均です。

「sample」設定の場合、ビンの量は単一のサンプルに対してのみ原子を合計し、カウントも同様に行い、「平均サンプル値」を計算します。すなわち、「Sample-quantity / Sample-count」です。ビンの出力値は、Nrepeat個の「平均サンプル値」の平均です。言い換えれば、これは平均の平均です。

「ave」キーワードは、Nfreqステップごとに出力されるビン値が、Nfreqの倍数の前のステップで生成されたビン値とどのように平均化されるかを決定します。その後、他の出力コマンドでアクセスされたり、ファイルに書き込まれたりします。

「ave」設定が「one」の場合、Nfreqの倍数のタイムステップで生成されたビン値は互いに独立しており、さらに平均化することなくそのまま出力されます。

「ave」設定が「running」の場合、Nfreqの倍数のタイムステップで生成されたビン値は累積的に合計され、平均化されてから出力されます。したがって、各出力ビン値は、そのタイムステップで生成されたビン値と、それ以前のすべての同じビンの値の平均となります。この累積平均は、fixが定義されたときに開始されます。再起動するには、unfixコマンドでfixを削除するか、再度fixを定義する必要があります。

「ave」設定が「window」の場合、Nfreqの倍数のタイムステップで生成されたビン値は、時間的に移動する「ウィンドウ」内で合計され、平均化されます。これにより、同じビンの最後のM値が出力を生成するために使用されます。例えば、M = 3およびNfreq = 1000の場合、ステップ10000での出力は、ステップ8000、9000、10000での個別のビン値の平均となります。早いステップの出力は、Mの値が利用できない場合はM未満の値で平均化されます。

「file」キーワードを使用すると、ファイル名を指定できます。Nfreqステップごとに、次の形式でビン情報のセクションがテキストファイルに書き込まれます。タイムステップとビンの数を含む行が書き込まれます。この行の出力は、write_tsキーワードを使用して抑制できます。

その後、各ビンごとに1行が書き込まれ、ビンID（1-N）、ビンの中心の座標、ビン内の原子の数、および1つ以上の計算された値が含まれます。各行の値の数は、fix ave/spatialコマンドで指定された値の数に対応します。原子の数と値は平均量です。unitsキーワードの値が「box」または「lattice」の場合、"coord"はボックス単位で表示されます。unitsキーワードの値が「reduced」の場合、"coord"は縮小単位（0-1）で表示されます。

「overwrite」キーワードは、出力ファイルを最新の出力で継続的に上書きするため、1つのタイムステップ分の出力のみを保持します。このオプションは、「ave running」設定とともにのみ使用できます。

title1、title2、title3キーワードは、ファイルキーワードが使用されている場合に、出力ファイルの最初の3行として印刷される文字列を指定できます。LIGGGHTS(R)-PUBLICはそれぞれのデフォルト値を使用するため、これらを指定する必要はありません。もしそれらのいずれかが「」として指定された場合、その行は省略されます。

デフォルトでは、これらのヘッダー行は次のようになります：
```
# Spatial-averaged data for fix ID and group name
# Timestep Number-of-bins
# Bin Coord1 Coord2 Coord3 Count value1 value2 ...
```
最初の行では、IDと名前はfix-IDとグループ名に置き換えられます。2行目は、各出力セクションの最初に印刷される2つの値を説明します。3行目では、値はfix ave/spatialコマンドからの適切なフィールドに置き換えられます。3行目のCoord2およびCoord3の項目は、それぞれ2dおよび3dビンに対してのみ表示されます。1dビンの場合、Coord1という単語はCoordに置き換えられます。


stdキーワードが設定されている場合、指定された値（value1、value2など）のサンプルごとの平均と標準偏差が計算されます。サンプルサイズは、下限（N1）と上限（N2 > N1）によって定義する必要があります。N1とN2（N1とN2を含む）の間の粒子数を持つすべてのビンがサンプルとして使用されます。毎Nfreqタイムステップごとに、N1とN2の後に指定されたファイルに1行が書き込まれ、次の数値が含まれます：タイムステップ、総原子数、ビンの総数、ビンごとの最大原子数、空のビンの数、N1より少ない原子を含むビンの数、N2より多い原子を含むビンの数、サンプル数、サンプルごとの平均原子数、その後、定義された値ごとに3つの量が続きます：真の平均（すべての原子について）、選ばれたサンプルの平均、選ばれたサンプルの標準偏差。標準偏差の計算には、サンプル平均ではなく（既知の）真の平均が使用されます（後者は真の平均の推定値に過ぎません！）。

# Restart, fix_modify, output, run start/stop, minimize info
このfixに関する情報は[binary restart file]()には書き込まれません。このfixに関連する[fix_modify]()オプションはありません。

このfixは、さまざまな[output commands]()でアクセスできるグローバルな値の配列を計算します。値はNfreqの倍数のタイムステップでのみアクセス可能で、そのタイムステップで平均が計算されるためです。グローバル配列の行数はNbins、列数はNdim+1+Nvaluesとなります。ここで、Ndimは1d、2d、3dのビンに対応する1、2、3です。最初の1列、2列、または3列は適切な次元でのビン座標（ビンの中心）を持ち、次の列はそのビン内の原子数、残りの列はNvalueの量です。この配列にアクセスする際に、現在のビン数を超えるIが指定された場合、エラーではなく0.0が返されます。シミュレーションが進行するにつれてビンの数が変化するため、シミュレーションボックスのサイズによってビンの数は変動する可能性があります。2dまたは3dビンは、最後の次元（または次元）が最速で変化するように並べられます。このfixによって計算された配列値は「集中的」なもので、すでに各ビン内の原子数で正規化されています。

このfixのパラメータは、[run]()コマンドのstart/stopキーワードと一緒に使用することはできません。このfixはエネルギー最小化中には呼び出されません。

# 制限事項
ave キーワードが running または window に設定されている場合、ビンの数はシミュレーション中に変わらない必要があります。これにより適切な平均化が行われます。シミュレーションボックスのサイズが変わらない場合や、units キーワードが reduced に設定されている場合には、この条件が満たされます。

# 関連コマンド
[compute](), [fix ave/atom](), [fix ave/histo](), [fix ave/time](), [variable](), [fix ave/correlate]()

# デフォルト
オプションのデフォルト設定は、units = box, norm = all, ファイル出力なし、ave = one, title 1,2,3 は上記のような文字列です。




