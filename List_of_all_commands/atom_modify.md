# atom_modify command

## 構文
```
atom_modify キーワード 値 ...
```

- 1つ以上のキーワード/値のペアを追加することができます。
- キーワード = map または first または sort

map の値 = array または hash  
first の値 = group-ID = 内部の原子リストに最初に現れる原子を持つグループ  
sort の値 = Nfreq binsize  
Nfreq = 空間的に原子を並べ替える時間ステップ数（この回数ごとに並べ替え）  
binsize = 空間的な並べ替えのためのビンのサイズ（距離単位）  

## 例
```
atom_modify map hash
atom_modify map array sort 10000 2.0
atom_modify first colloid
```

## 説明
LIGGGHTS(R)-PUBLIC内で選択された原子スタイルのプロパティを変更します。

map キーワードは、分子問題における原子IDの検索方法を決定します。検索は、LIGGGHTS(R)-PUBLICの結合（角度など）ルーチンによって行われ、グローバルな原子IDに関連するローカルな原子インデックスを見つけます。array 値が使用される場合、各プロセッサは長さNのルックアップテーブルを格納します。ここで、Nはシステム内の原子の総数です。この方法はほとんどのシミュレーションで最速ですが、非常に大きなシミュレーションではテーブルを格納するためにプロセッサのメモリが不足する可能性があります。hash 値は、ハッシュテーブルを使用してルックアップを行います。この方法はarray方式よりも少し遅くなることがありますが、メモリコストはN/Pに比例し、ここでPはシミュレーションを実行しているプロセッサの総数です。

first キーワードは、[group]()を指定して、そのグループの原子を各プロセッサの所有する原子リストの最初の原子として維持します。このオプションは、指定されたグループがすべての原子の中で小さな割合である場合に有効であり、LIGGGHTS(R)-PUBLICが実行している他の操作が、この小さな原子セットに対してループすることで大幅に高速化される場合に役立ちます。そうでない場合、このオプションによる再順序付けは全体的に遅くなることがあります。例えば、[neigh_modify include]() や [communicate group]() コマンドなどは、この設定が効率的に動作するために必要です。いくつかの[fixes]()（特に、[fix nve]()のような時間積分に関連するfix）は、この設定を利用しており、操作対象のグループがこのコマンドで指定されたグループである場合に有効です。なお、グループIDとして「all」を指定すると、first オプションは実質的に無効になります。

first キーワードを、まだ定義されていないグループに対して使用することは問題ありません。例えば、入力スクリプトの最初で atom_modify first コマンドを使用することができます。LIGGGHTS(R)-PUBLICは、シミュレーションが実行されるまでそのグループを使用しません。

sort キーワードは、各プロセッサのサブドメイン内で原子の空間的な並べ替えまたは再順序付けを、Nfreqタイムステップごとに実行します。Nfreqが0に設定されている場合、並べ替えは無効になります。並べ替えはキャッシュのパフォーマンスを改善し、その結果、LIGGGHTS(R)-PUBLICのシミュレーションを高速化する可能性があります。これは(Meloni, Rosati and Colombo, J Chem Phys, 126, 121102 (2007).)の論文でも議論されています。並べ替えの効率は、問題のサイズ（原子/プロセッサ）、システムがどれだけ早く乱雑になるか、およびその他のさまざまな要因に依存します。一般的に、並べ替えは液体のシミュレーションの方が固体のシミュレーションよりも効果的です。私たちが行ったテストでは、速度向上はゼロから3〜4倍の範囲であることがわかりました。

再順序付けは、動力学シミュレーション中のNfreqタイムステップごと、または最小化中の繰り返しごとに実行されます。正確には、再順序付けはターゲットタイムステップ後の最初の再隣接化（reneighboring）時に行われます。再順序付けは、各プロセッサが指定されたビンサイズを使用してローカルに実行します。もしビンサイズが0.0に設定されている場合、ビンサイズは[neighbor]()カットオフ距離（力のカットオフ距離とスキン距離の合計）の半分と同じ値が使用されます。これは妥当な値です。原子がビンに分けられた後、それらは再順序付けされ、同じビンに属する原子がプロセッサの1次元原子リストで隣接するようになります。

この手順の目的は、空間的に近い原子同士を、プロセッサの1次元原子リストでも近くに配置することです。これにより、ペアワイズ相互作用や隣接リストの計算時にキャッシュのパフォーマンスが向上する可能性があります。ビンが小さすぎると、1ビンあたりの原子が少なくなり、逆にビンが大きすぎると、1ビンあたりの原子が多くなります。この場合、キャッシュの局所性という目標は達成されません。

[!warning]

並べ替えをオンにした場合とオフにした場合でシミュレーション結果が統計的に変わることはないはずです。ただし、異なる順序が丸め誤差を引き起こし、2つのシミュレーションを比較した際に時間が経つにつれて軌道が発散する原因となります。特にランダムな数値を使用するコマンドなど、さまざまなコマンドは、原子が処理される順序に依存して（統計的には同じ）結果を生成することがあります。また、並べ替えが有効になっている場合、ダンプファイル内の原子の順序も通常変更されます。

## 制限事項
map キーワードは、シミュレーションボックスが [read_data]() または [create_box]() コマンドで定義される前にのみ使用できます。

first と sort オプションは一緒に使用できません。並べ替えはデフォルトでオンになっているため、first キーワードが「all」以外のグループIDと共に使用されると、並べ替えはオフになります。

関連コマンド: なし

## デフォルト
デフォルトでは、非分子問題にはマップは割り当てられません。分子問題の場合、デフォルトオプションは map = array です。
デフォルトでは、「first」グループは定義されていません。
デフォルトでは、並べ替えが有効で、頻度は1000、ビンサイズは0.0に設定されています。これは、隣接カットオフを使用してビンサイズが設定されることを意味します。